#!/usr/bin/env bash

# Configuration
repo="https://github.com/knowler/dotfiles.git"
git_dir="$HOME/.dotfiles"
install_dir="$HOME"

# Ask for sudo password and keep alive
sudo -v 
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Helpers
installed() { command -v $1 >/dev/null 2>&1; }
dots() { git --git-dir=$git_dir --work-tree=$install_dir $@; }
dots-alias() { 
  # Unset the alias so we have a fresh one
  dots config --unset alias.$1
  # Funky string stuff happens when trying to use dots here so we set with git itself
  git --git-dir=$git_dir config alias.$1 "$2"; 
}
os=$(uname -s); 
release=$(uname -r)

# Set up package manager
if [[ $os =~ "Darwin" ]]; then
  installed brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  alias install_package="brew"
elif [[ $os =~ "Linux" && $release =~ "MANJARO" ]]; then
  installed yay || sudo pacman -S yay
  alias install_package="yay -Sy"
else
  echo "Does not support this operating system or distribution." 
  exit 1
fi

installed just || install_package just              # Install just, if not already
[ -d $git_dir ] || git clone $repo $git_dir --bare  # Clone as a bare repository, if not already

# Alias maintenance commands
dots-alias install '!just install'
dots-alias setup '!just setup'
dots-alias upgrade '!just upgrade'
dots-alias dump '!just dump'
dots-alias open '!dot'
# End maintenance command aliases

dots config status.showUntrackedFiles no            # Set dotfiles config to not show untracked file in status
dots checkout                                       # Checkout in install directory
dots install                                        # Install packages
dots setup                                          # Run post-install setup for some applications
exec $SHELL -l                                      # Reload the shell
